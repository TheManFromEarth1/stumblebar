#!/bin/bash

set -e

pushd "$(dirname "$0")/../"

rm -rf target
mkdir -p target
mkdir -p artifact

git ls-tree -r master --name-only | while read FILE; do
	if [[ "$(echo "$FILE" | grep /)" ]]; then mkdir -p "target/$(dirname "$FILE")"; fi
	if [[ "$(dirname "$FILE")" == "utils" ]]; then continue; fi
	cp -rp {,target/}"$FILE"
done


# Firefox
echo -e "\n\n\n========= START Firefox"
cd target
zip -r ../artifact/StumbleBar\ Firefox\ $(cat manifest.json | grep '"version"' | sed -e 's/.*: "//' -e 's/".*//').zip .
if [ "$PUSH_MOZILLA" ]; then
	web-ext sign --api-key=$AMO_JWT_ISSUER --api-secret=$AMO_JWT_SECRET --artifacts-dir=../artifact/
fi
echo -e "========= END Firefox\n\n\n"

# Chrome
echo -e "========= START Chrome"
cd ..
cat manifest.json | pcregrep -v -M '"applications"(.|\n)*?},' > target/manifest.json
rm -rf StumbleBar
cp -rp target StumbleBar
zip -r artifact/StumbleBar\ Chrome\ $(cat manifest.json | grep '"version"' | sed -e 's/.*: "//' -e 's/".*//').zip StumbleBar
rm -rf target StumbleBar
if [ "$PUSH_CHROME" ]; then
	#WEBSTORE_TOKEN="$(chrome-webstore-manager token --client_id $WEBSTORE_CLIENT_ID --client_secret $WEBSTORE_CLIENT_SECRET)"
	WEBSTORE_TOKEN="$(chrome-webstore-manager refresh_token --client_id $WEBSTORE_CLIENT_ID --client_secret $WEBSTORE_CLIENT_SECRET --refresh_token $WEBSTORE_REFRESH_TOKEN)"
	chrome-webstore-manager update  -t $WEBSTORE_TOKEN $WEBSTORE_EXTENSION_ID "artifact/StumbleBar Chrome $(cat manifest.json | grep '"version"' | sed -e 's/.*: "//' -e 's/".*//').zip"
	chrome-webstore-manager publish -t $WEBSTORE_TOKEN $WEBSTORE_EXTENSION_ID
fi;
echo -e "========= END Chrome\n\n\n"

popd

